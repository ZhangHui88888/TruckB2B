# å†…å®¹è‡ªåŠ¨åŒ–å·¥ä½œæµ
# 
# æ¯å‘¨è‡ªåŠ¨ä¼˜åŒ–äº§å“æè¿°å’Œç”Ÿæˆåšå®¢æ–‡ç« è‰ç¨¿
# 
# æ³¨æ„ï¼šç”Ÿæˆçš„å†…å®¹ä¼šä¿å­˜ä¸ºè‰ç¨¿ï¼Œéœ€è¦äººå·¥å®¡æ ¸åæ‰å‘å¸ƒ

name: Content Automation

on:
  schedule:
    # æ¯å‘¨æ—¥ 02:00 UTC (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * 0'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      optimize_products:
        description: 'ä¼˜åŒ–äº§å“æè¿°'
        required: false
        default: 'true'
        type: boolean
      generate_blog:
        description: 'ç”Ÿæˆåšå®¢æ–‡ç« '
        required: false
        default: 'true'
        type: boolean
      blog_topics:
        description: 'åšå®¢ä¸»é¢˜ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string

jobs:
  content-automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: xk-truck-frontend/package-lock.json

      - name: Install dependencies
        working-directory: xk-truck-frontend
        run: npm install

      - name: Optimize Product Descriptions
        if: ${{ github.event.inputs.optimize_products != 'false' }}
        working-directory: xk-truck-frontend
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "ğŸ”§ ä¼˜åŒ–äº§å“æè¿°..."
          node scripts/optimize-descriptions.js || echo "ä¼˜åŒ–å®Œæˆæˆ–è·³è¿‡"

      - name: Generate Blog Posts
        if: ${{ github.event.inputs.generate_blog != 'false' }}
        working-directory: xk-truck-frontend
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ“ ç”Ÿæˆåšå®¢æ–‡ç« ..."
          
          # é»˜è®¤ä¸»é¢˜åˆ—è¡¨
          TOPICS=(
            "How to Choose Quality Truck Headlamps"
            "Common Truck Mirror Problems and Solutions"
            "Understanding OE Numbers for Truck Parts"
            "Truck Parts Maintenance Tips"
            "Comparing European Truck Brands"
          )
          
          # å¦‚æœæä¾›äº†è‡ªå®šä¹‰ä¸»é¢˜ï¼Œä½¿ç”¨è‡ªå®šä¹‰ä¸»é¢˜
          if [ -n "${{ github.event.inputs.blog_topics }}" ]; then
            IFS=',' read -ra TOPICS <<< "${{ github.event.inputs.blog_topics }}"
          fi
          
          # éšæœºé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ç”Ÿæˆæ–‡ç« 
          RANDOM_TOPIC="${TOPICS[$RANDOM % ${#TOPICS[@]}]}"
          echo "ç”Ÿæˆä¸»é¢˜: $RANDOM_TOPIC"
          
          node scripts/generate-blog-post.js "$RANDOM_TOPIC" || echo "ç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: AI generated content updates'
          branch: content-automation
          delete-branch: true
          title: 'ğŸ¤– AI ç”Ÿæˆçš„å†…å®¹æ›´æ–°'
          body: |
            ## ğŸ“ è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹
            
            æœ¬ PR åŒ…å« AI è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹æ›´æ–°ï¼š
            
            ### âœ… å·²å®Œæˆ
            - äº§å“æè¿°ä¼˜åŒ–
            - åšå®¢æ–‡ç« ç”Ÿæˆï¼ˆè‰ç¨¿ï¼‰
            
            ### âš ï¸ éœ€è¦å®¡æ ¸
            è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
            1. äº§å“æè¿°æ˜¯å¦å‡†ç¡®
            2. åšå®¢æ–‡ç« è´¨é‡
            3. æ˜¯å¦éœ€è¦æ·»åŠ å›¾ç‰‡
            4. æ˜¯å¦éœ€è¦è°ƒæ•´è¯­æ°”
            
            ### ğŸ“Š ä¸‹ä¸€æ­¥
            - [ ] å®¡æ ¸äº§å“æè¿°
            - [ ] å®¡æ ¸åšå®¢æ–‡ç« 
            - [ ] æ·»åŠ å›¾ç‰‡ï¼ˆå¦‚éœ€è¦ï¼‰
            - [ ] åˆå¹¶ PR
            - [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
            
            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          labels: |
            automated
            content
            needs-review

      - name: Send Notification
        if: always()
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          echo "ğŸ“§ å‘é€é€šçŸ¥é‚®ä»¶..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶é€šçŸ¥é€»è¾‘
          echo "å†…å®¹è‡ªåŠ¨åŒ–å®Œæˆï¼Œè¯·æŸ¥çœ‹ GitHub PR"

      - name: Summary
        run: |
          echo "## å†…å®¹è‡ªåŠ¨åŒ–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¥æœŸ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **äº§å“æè¿°**: å·²ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- **åšå®¢æ–‡ç« **: å·²ç”Ÿæˆè‰ç¨¿" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ Pull Request è¿›è¡Œå®¡æ ¸ã€‚" >> $GITHUB_STEP_SUMMARY
