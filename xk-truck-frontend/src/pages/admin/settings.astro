---
/**
 * 管理后台 - 系统设置
 */
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Settings" currentPage="settings">
  <div class="max-w-3xl">
    <!-- AI 客服设置 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">AI Assistant Settings</h2>
      
      <div class="space-y-6">
        <!-- AI 开关 -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <h3 class="font-medium text-gray-900">AI Auto-Reply</h3>
            <p class="text-sm text-gray-500 mt-1">
              When enabled, AI will automatically respond to customer messages
            </p>
          </div>
          <button
            id="ai-toggle"
            class="relative w-14 h-7 rounded-full transition-colors bg-gray-300"
            data-enabled="false"
          >
            <span class="absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform shadow-sm"></span>
          </button>
        </div>

        <!-- 欢迎消息 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Message</label>
          <textarea
            id="welcome-message"
            rows="3"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="Hello! Welcome to XKTRUCK. How can I help you today?"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">This message is shown when a customer starts a chat</p>
        </div>

        <!-- 系统提示词 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">AI System Prompt</label>
          <textarea
            id="system-prompt"
            rows="6"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary font-mono text-sm"
            placeholder="You are a professional customer service assistant..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">Instructions for the AI on how to respond to customers</p>
        </div>
      </div>
    </div>

    <!-- 通知设置 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Notification Settings</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notification Email</label>
          <input
            type="email"
            id="notify-email"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="your@email.com"
          />
          <p class="text-xs text-gray-500 mt-1">Receive inquiry and chat notifications at this email</p>
        </div>

        <div class="flex items-center gap-3">
          <input type="checkbox" id="notify-inquiries" class="w-4 h-4 text-primary rounded" checked />
          <label for="notify-inquiries" class="text-sm text-gray-700">Email me for new inquiries</label>
        </div>

        <div class="flex items-center gap-3">
          <input type="checkbox" id="notify-chats" class="w-4 h-4 text-primary rounded" checked />
          <label for="notify-chats" class="text-sm text-gray-700">Email me for chat messages (when AI is disabled)</label>
        </div>
      </div>
    </div>

    <!-- 保存按钮 -->
    <div class="flex items-center justify-between">
      <p id="save-status" class="text-sm text-gray-500"></p>
      <button
        id="btn-save"
        class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition-colors"
      >
        Save Settings
      </button>
    </div>
  </div>
</AdminLayout>

<script>
  const API_URL = 'https://xk-truck-api.harry-zhang592802.workers.dev';
  const ADMIN_API_KEY = 'xktruck_admin_2024_secure';

  // 加载设置
  async function loadSettings() {
    try {
      const res = await fetch(`${API_URL}/api/settings`);
      const data = await res.json();
      
      if (data.success && data.data) {
        const settings = data.data;
        
        // AI 开关
        const toggle = document.getElementById('ai-toggle') as HTMLButtonElement;
        const span = toggle.querySelector('span');
        if (settings.ai_enabled) {
          toggle.dataset.enabled = 'true';
          toggle.classList.remove('bg-gray-300');
          toggle.classList.add('bg-green-500');
          span!.classList.add('translate-x-7');
        }
        
        // 欢迎消息
        (document.getElementById('welcome-message') as HTMLTextAreaElement).value = settings.welcome_message || '';
        
        // 系统提示词
        (document.getElementById('system-prompt') as HTMLTextAreaElement).value = settings.system_prompt || '';
        
        // 通知邮箱
        (document.getElementById('notify-email') as HTMLInputElement).value = settings.notify_email || '';
        
        // 通知开关
        (document.getElementById('notify-inquiries') as HTMLInputElement).checked = settings.notify_inquiries !== false;
        (document.getElementById('notify-chats') as HTMLInputElement).checked = settings.notify_chats !== false;
      }
    } catch (error) {
      console.error('Failed to load settings:', error);
    }
  }

  // AI 开关切换
  document.getElementById('ai-toggle')?.addEventListener('click', (e) => {
    const toggle = e.currentTarget as HTMLButtonElement;
    const span = toggle.querySelector('span');
    const isEnabled = toggle.dataset.enabled === 'true';
    
    if (isEnabled) {
      toggle.dataset.enabled = 'false';
      toggle.classList.remove('bg-green-500');
      toggle.classList.add('bg-gray-300');
      span!.classList.remove('translate-x-7');
    } else {
      toggle.dataset.enabled = 'true';
      toggle.classList.remove('bg-gray-300');
      toggle.classList.add('bg-green-500');
      span!.classList.add('translate-x-7');
    }
  });

  // 保存设置
  document.getElementById('btn-save')?.addEventListener('click', async () => {
    const btn = document.getElementById('btn-save') as HTMLButtonElement;
    const status = document.getElementById('save-status');
    
    btn.disabled = true;
    btn.textContent = 'Saving...';
    status!.textContent = '';
    
    const settings = {
      ai_enabled: (document.getElementById('ai-toggle') as HTMLButtonElement).dataset.enabled === 'true',
      welcome_message: (document.getElementById('welcome-message') as HTMLTextAreaElement).value,
      system_prompt: (document.getElementById('system-prompt') as HTMLTextAreaElement).value,
      notify_email: (document.getElementById('notify-email') as HTMLInputElement).value,
      notify_inquiries: (document.getElementById('notify-inquiries') as HTMLInputElement).checked,
      notify_chats: (document.getElementById('notify-chats') as HTMLInputElement).checked,
    };

    try {
      const res = await fetch(`${API_URL}/api/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ADMIN_API_KEY}`
        },
        body: JSON.stringify(settings)
      });
      
      const data = await res.json();
      
      if (data.success) {
        status!.textContent = '✓ Settings saved successfully';
        status!.className = 'text-sm text-green-600';
      } else {
        throw new Error(data.error || 'Failed to save');
      }
    } catch (error: any) {
      status!.textContent = '✕ ' + (error.message || 'Failed to save settings');
      status!.className = 'text-sm text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Save Settings';
      
      // 3秒后清除状态
      setTimeout(() => {
        status!.textContent = '';
      }, 3000);
    }
  });

  // 初始化
  document.addEventListener('DOMContentLoaded', () => {
    const checkAndLoad = () => {
      if (sessionStorage.getItem('xktruck_admin_auth') === 'true') {
        loadSettings();
      } else {
        setTimeout(checkAndLoad, 500);
      }
    };
    checkAndLoad();
  });
</script>
