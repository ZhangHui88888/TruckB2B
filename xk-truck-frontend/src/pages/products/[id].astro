---
import Layout from '../../layouts/Layout.astro';
import { getAllProductSlugs, getProductBySlug, type Product } from '../../lib/supabase';

export async function getStaticPaths() {
  // 从 Supabase 获取所有产品 slugs
  const slugs = await getAllProductSlugs();
  
  // 如果数据库为空，使用示例数据
  if (slugs.length === 0) {
    const sampleProducts = [
      {
        id: '1',
        slug: 'volvo-fh4-led-headlamp-left',
        name: 'VOLVO FH4 LED Headlamp Left',
        brand_name: 'VOLVO',
        brand_slug: 'volvo',
        category_name: 'Headlamps',
        category_slug: 'headlamps',
        oe_number: '21221129',
        cross_reference: ['21221130', '21221131'],
        fitment: ['VOLVO FH4 2013-2020', 'VOLVO FM4 2013-2020'],
        main_image_url: '',
        images: [],
        description: 'High quality LED headlamp for VOLVO FH4 series trucks. This aftermarket headlamp is manufactured to OEM specifications and features advanced LED technology for superior visibility and durability.',
        features: [
          'LED technology for better visibility',
          'OEM quality construction',
          'Direct fit replacement',
          'ADB certified',
          'Weather resistant'
        ],
        specifications: {
          'Part Type': 'Headlamp',
          'Position': 'Left (Driver Side)',
          'Light Source': 'LED',
          'Voltage': '24V',
          'Material': 'PP + PC',
          'Certification': 'ADB, E-Mark'
        },
        is_active: true,
        is_featured: false,
        created_at: '',
        updated_at: '',
      },
    ];
    
    return sampleProducts.map(product => ({
      params: { id: product.slug },
      props: { product }
    }));
  }
  
  // 为每个 slug 生成静态路径
  const paths = await Promise.all(
    slugs.map(async (slug) => {
      const product = await getProductBySlug(slug);
      return {
        params: { id: slug },
        props: { product }
      };
    })
  );
  
  return paths.filter(p => p.props.product !== null);
}

const { product } = Astro.props as { product: Product };

// 如果产品不存在，重定向到产品列表
if (!product) {
  return Astro.redirect('/products');
}

// Enhanced Product Schema.org structured data
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": product.name,
  "image": product.images && product.images.length > 0 
    ? product.images 
    : [product.main_image_url || "https://xk-truck.cn/images/placeholder.jpg"],
  "description": product.description || product.short_description || `${product.name} - OEM quality aftermarket part`,
  "sku": product.sku || product.oe_number,
  "mpn": product.oe_number,
  "gtin": product.oe_number,
  "brand": {
    "@type": "Brand",
    "name": product.brand_name || "XKTRUCK"
  },
  "manufacturer": {
    "@type": "Organization",
    "@id": "https://xk-truck.cn/#organization"
  },
  "category": product.category_name,
  "material": product.specifications?.Material || product.specifications?.['Material'],
  "additionalProperty": [
    ...(product.fitment ? product.fitment.map((fit: string) => ({
      "@type": "PropertyValue",
      "name": "Compatible Vehicle",
      "value": fit
    })) : []),
    ...(product.cross_reference ? product.cross_reference.map((ref: string) => ({
      "@type": "PropertyValue", 
      "name": "Cross Reference",
      "value": ref
    })) : []),
    ...(product.specifications ? Object.entries(product.specifications).map(([key, value]) => ({
      "@type": "PropertyValue",
      "name": key,
      "value": value
    })) : [])
  ],
  "offers": {
    "@type": "Offer",
    "url": `https://xk-truck.cn/products/${product.slug}`,
    "priceCurrency": "USD",
    "price": "0",
    "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition",
    "seller": {
      "@type": "Organization",
      "@id": "https://xk-truck.cn/#organization"
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingDestination": {
        "@type": "DefinedRegion",
        "addressCountry": "Worldwide"
      },
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {
          "@type": "QuantitativeValue",
          "minValue": 1,
          "maxValue": 3,
          "unitCode": "DAY"
        },
        "transitTime": {
          "@type": "QuantitativeValue",
          "minValue": 15,
          "maxValue": 30,
          "unitCode": "DAY"
        }
      }
    }
  }
};

// BreadcrumbList Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://xk-truck.cn"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Products",
      "item": "https://xk-truck.cn/products"
    },
    ...(product.brand_name ? [{
      "@type": "ListItem",
      "position": 3,
      "name": product.brand_name,
      "item": `https://xk-truck.cn/brands/${product.brand_slug}`
    }] : []),
    {
      "@type": "ListItem",
      "position": product.brand_name ? 4 : 3,
      "name": product.name,
      "item": `https://xk-truck.cn/products/${product.slug}`
    }
  ]
};
---

<Layout 
  title={product.name}
  description={`${product.name} - OE: ${product.oe_number}. ${(product.description || '').slice(0, 150)}...`}
  schema={[productSchema, breadcrumbSchema]}
>
  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center gap-2 text-gray-500">
        <li><a href="/" class="hover:text-primary">Home</a></li>
        <li>/</li>
        <li><a href="/products" class="hover:text-primary">Products</a></li>
        {product.brand_slug && (
          <>
            <li>/</li>
            <li>
              <a href={`/brands/${product.brand_slug}`} class="hover:text-primary">
                {product.brand_name}
              </a>
            </li>
          </>
        )}
        <li>/</li>
        <li class="text-gray-900 truncate max-w-[200px]">{product.name}</li>
      </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
      <!-- Product Images -->
      <div>
        <div class="bg-gray-100 rounded-xl aspect-square overflow-hidden mb-4" id="main-image">
          {product.main_image_url ? (
            <img 
              src={product.main_image_url} 
              alt={product.name}
              class="w-full h-full object-contain"
              id="main-product-image"
            />
          ) : (
            <div class="w-full h-full flex items-center justify-center">
              <svg class="w-32 h-32 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
          )}
        </div>
        
        <!-- Thumbnail Gallery -->
        {product.images && product.images.length > 0 ? (
          <div class="grid grid-cols-4 gap-2">
            {product.images.slice(0, 4).map((img, index) => (
              <button 
                class={`bg-gray-100 rounded-lg aspect-square overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary ${index === 0 ? 'ring-2 ring-primary' : ''}`}
                data-image={img}
                onclick="document.getElementById('main-product-image').src = this.dataset.image; document.querySelectorAll('[data-image]').forEach(el => el.classList.remove('ring-2', 'ring-primary')); this.classList.add('ring-2', 'ring-primary');"
              >
                <img src={img} alt={`${product.name} - Image ${index + 1}`} class="w-full h-full object-cover" />
              </button>
            ))}
          </div>
        ) : (
          <div class="grid grid-cols-4 gap-2">
            {[1, 2, 3, 4].map(() => (
              <div class="bg-gray-100 rounded-lg aspect-square flex items-center justify-center">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
            ))}
          </div>
        )}
      </div>

      <!-- Product Info -->
      <div>
        <div class="mb-4 flex flex-wrap gap-2">
          {product.brand_name && (
            <a href={`/brands/${product.brand_slug}`} class="bg-primary text-white text-sm font-medium px-3 py-1 rounded hover:bg-primary-dark transition-colors">
              {product.brand_name}
            </a>
          )}
          {product.category_name && (
            <a href={`/products?category=${product.category_slug}`} class="bg-gray-100 text-gray-700 text-sm font-medium px-3 py-1 rounded hover:bg-gray-200 transition-colors">
              {product.category_name}
            </a>
          )}
        </div>
        
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">{product.name}</h1>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            {product.oe_number && (
              <div>
                <span class="text-gray-500">OE Number:</span>
                <span class="font-semibold text-gray-900 ml-2">{product.oe_number}</span>
              </div>
            )}
            {product.cross_reference && product.cross_reference.length > 0 && (
              <div>
                <span class="text-gray-500">Cross Ref:</span>
                <span class="font-semibold text-gray-900 ml-2">{product.cross_reference.join(', ')}</span>
              </div>
            )}
            {product.sku && (
              <div>
                <span class="text-gray-500">SKU:</span>
                <span class="font-semibold text-gray-900 ml-2">{product.sku}</span>
              </div>
            )}
            {product.fitment_years && (
              <div>
                <span class="text-gray-500">Years:</span>
                <span class="font-semibold text-gray-900 ml-2">{product.fitment_years}</span>
              </div>
            )}
          </div>
        </div>

        {product.description && (
          <p class="text-gray-600 mb-6 whitespace-pre-line">{product.description}</p>
        )}

        <!-- Fitment -->
        {product.fitment && product.fitment.length > 0 && (
          <div class="mb-6">
            <h3 class="font-semibold text-gray-900 mb-2">Fitment / Compatible Vehicles</h3>
            <ul class="space-y-1">
              {product.fitment.map((fit) => (
                <li class="flex items-center gap-2 text-gray-600">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  {fit}
                </li>
              ))}
            </ul>
          </div>
        )}

        <!-- CTA Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
          <a 
            href={`https://wa.me/8613062870118?text=Hi, I'm interested in ${encodeURIComponent(product.name)}${product.oe_number ? ` (OE: ${product.oe_number})` : ''}`}
            target="_blank"
            rel="noopener noreferrer"
            class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors inline-flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            Inquire on WhatsApp
          </a>
          <a 
            href="/contact"
            class="flex-1 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors"
          >
            Request Quote
          </a>
        </div>

        <!-- Features -->
        {product.features && product.features.length > 0 && (
          <div class="border-t pt-6">
            <h3 class="font-semibold text-gray-900 mb-3">Features</h3>
            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              {product.features.map((feature) => (
                <li class="flex items-center gap-2 text-gray-600">
                  <svg class="w-4 h-4 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  {feature}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>

    <!-- Specifications -->
    {product.specifications && Object.keys(product.specifications).length > 0 && (
      <section class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Specifications</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {Object.entries(product.specifications).map(([key, value]) => (
            <div class="flex justify-between py-2 border-b border-gray-100">
              <span class="text-gray-500">{key}</span>
              <span class="font-medium text-gray-900">{value}</span>
            </div>
          ))}
        </div>
      </section>
    )}
  </div>

</Layout>
