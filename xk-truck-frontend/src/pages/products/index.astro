---
import Layout from '../../layouts/Layout.astro';
import { getBrands, getCategories, getProducts, type Product } from '../../lib/supabase';

// 获取 URL 参数
const url = new URL(Astro.request.url);
const brandFilter = url.searchParams.get('brand') || undefined;
const categoryFilter = url.searchParams.get('category') || undefined;
const searchQuery = url.searchParams.get('search') || undefined;
const currentPage = parseInt(url.searchParams.get('page') || '1');
const pageSize = 12;

// 从 Supabase 获取数据
const [brandsData, categoriesData, productsResult] = await Promise.all([
  getBrands(),
  getCategories(),
  getProducts({
    brand: brandFilter,
    category: categoryFilter,
    search: searchQuery,
    page: currentPage,
    pageSize,
  }),
]);

// 品牌和分类列表
const brands = brandsData.map(b => b.name);
const categories = categoriesData.map(c => c.name);

// 产品数据
const products = productsResult.products;
const totalProducts = productsResult.total;
const totalPages = productsResult.totalPages;

// 如果没有从数据库获取到数据，使用示例数据
const sampleProducts: Product[] = [
  {
    id: '1',
    name: 'VOLVO FH4 LED Headlamp Left',
    slug: 'volvo-fh4-led-headlamp-left',
    brand_name: 'VOLVO',
    brand_slug: 'volvo',
    category_name: 'Headlamps',
    category_slug: 'headlamps',
    oe_number: '21221129',
    main_image_url: '',
    short_description: 'High quality LED headlamp for VOLVO FH4 series trucks',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
  {
    id: '2',
    name: 'SCANIA R Series Mirror Assembly',
    slug: 'scania-r-series-mirror-assembly',
    brand_name: 'SCANIA',
    brand_slug: 'scania',
    category_name: 'Mirrors',
    category_slug: 'mirrors',
    oe_number: '1723519',
    main_image_url: '',
    short_description: 'Complete mirror assembly for SCANIA R series',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
  {
    id: '3',
    name: 'MERCEDES-BENZ Actros Grille',
    slug: 'mercedes-benz-actros-grille',
    brand_name: 'MERCEDES-BENZ',
    brand_slug: 'mercedes-benz',
    category_name: 'Grilles',
    category_slug: 'grilles',
    oe_number: '9437500918',
    main_image_url: '',
    short_description: 'Front grille for Mercedes-Benz Actros MP4',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
  {
    id: '4',
    name: 'MAN TGX Fog Lamp',
    slug: 'man-tgx-fog-lamp',
    brand_name: 'MAN',
    brand_slug: 'man',
    category_name: 'Lighting',
    category_slug: 'lighting',
    oe_number: '81251016521',
    main_image_url: '',
    short_description: 'Fog lamp for MAN TGX series trucks',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
  {
    id: '5',
    name: 'IVECO Stralis Bumper',
    slug: 'iveco-stralis-bumper',
    brand_name: 'IVECO',
    brand_slug: 'iveco',
    category_name: 'Bumpers',
    category_slug: 'bumpers',
    oe_number: '504284315',
    main_image_url: '',
    short_description: 'Front bumper for IVECO Stralis',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
  {
    id: '6',
    name: 'DAF XF Mirror Cover',
    slug: 'daf-xf-mirror-cover',
    brand_name: 'DAF',
    brand_slug: 'daf',
    category_name: 'Mirrors',
    category_slug: 'mirrors',
    oe_number: '1689348',
    main_image_url: '',
    short_description: 'Mirror cover for DAF XF series',
    is_active: true,
    is_featured: false,
    created_at: '',
    updated_at: '',
  },
];

// 使用数据库数据或示例数据
const displayProducts = products.length > 0 ? products : sampleProducts;
const displayBrands = brands.length > 0 ? brands : ['VOLVO', 'SCANIA', 'MERCEDES-BENZ', 'MAN', 'IVECO', 'RENAULT', 'DAF', 'FORD'];
const displayCategories = categories.length > 0 ? categories : ['Headlamps', 'Mirrors', 'Body Parts', 'Lighting', 'Grilles', 'Bumpers'];

// 构建分页 URL
function buildPageUrl(page: number) {
  const params = new URLSearchParams();
  if (brandFilter) params.set('brand', brandFilter);
  if (categoryFilter) params.set('category', categoryFilter);
  if (searchQuery) params.set('search', searchQuery);
  params.set('page', page.toString());
  return `/products?${params.toString()}`;
}
---

<Layout 
  title="Products" 
  description="Browse our complete range of heavy truck parts - headlamps, mirrors, body parts for VOLVO, SCANIA, MERCEDES-BENZ, MAN, IVECO, RENAULT, DAF, FORD."
>
  <!-- Page Header -->
  <section class="bg-gray-900 text-white py-12">
    <div class="container mx-auto px-4">
      <h1 class="text-3xl md:text-4xl font-bold mb-4">Products</h1>
      <p class="text-gray-300 max-w-2xl">
        Browse our complete catalog of heavy truck parts. Filter by brand or category to find what you need.
      </p>
    </div>
  </section>

  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar Filters -->
      <aside class="lg:w-64 flex-shrink-0">
        <form class="bg-white rounded-xl shadow-sm p-6 sticky top-24" method="get" action="/products">
          <!-- Active Filters -->
          {(brandFilter || categoryFilter || searchQuery) && (
            <div class="mb-4 pb-4 border-b">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500">Active Filters</span>
                <a href="/products" class="text-xs text-primary hover:underline">Clear All</a>
              </div>
              <div class="flex flex-wrap gap-2">
                {brandFilter && (
                  <span class="inline-flex items-center gap-1 bg-primary/10 text-primary text-xs px-2 py-1 rounded">
                    {brandFilter.toUpperCase()}
                  </span>
                )}
                {categoryFilter && (
                  <span class="inline-flex items-center gap-1 bg-primary/10 text-primary text-xs px-2 py-1 rounded">
                    {categoryFilter}
                  </span>
                )}
                {searchQuery && (
                  <span class="inline-flex items-center gap-1 bg-primary/10 text-primary text-xs px-2 py-1 rounded">
                    "{searchQuery}"
                  </span>
                )}
              </div>
            </div>
          )}

          <!-- Brand Filter -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-900 mb-3">Brand</h3>
            <div class="space-y-2">
              {displayBrands.map(brand => {
                const brandSlug = brand.toLowerCase().replace(/\s+/g, '-');
                const isActive = brandFilter === brandSlug;
                return (
                  <a 
                    href={isActive ? '/products' : `/products?brand=${brandSlug}`}
                    class={`flex items-center gap-2 cursor-pointer hover:text-primary transition-colors ${isActive ? 'text-primary font-medium' : 'text-gray-700'}`}
                  >
                    <span class={`w-4 h-4 rounded border flex items-center justify-center ${isActive ? 'bg-primary border-primary' : 'border-gray-300'}`}>
                      {isActive && (
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                      )}
                    </span>
                    <span>{brand}</span>
                  </a>
                );
              })}
            </div>
          </div>

          <!-- Category Filter -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-900 mb-3">Category</h3>
            <div class="space-y-2">
              {displayCategories.map(category => {
                const categorySlug = category.toLowerCase().replace(/\s+/g, '-');
                const isActive = categoryFilter === categorySlug;
                return (
                  <a 
                    href={isActive ? '/products' : `/products?category=${categorySlug}`}
                    class={`flex items-center gap-2 cursor-pointer hover:text-primary transition-colors ${isActive ? 'text-primary font-medium' : 'text-gray-700'}`}
                  >
                    <span class={`w-4 h-4 rounded border flex items-center justify-center ${isActive ? 'bg-primary border-primary' : 'border-gray-300'}`}>
                      {isActive && (
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                      )}
                    </span>
                    <span>{category}</span>
                  </a>
                );
              })}
            </div>
          </div>

          <!-- Search -->
          <div>
            <h3 class="font-semibold text-gray-900 mb-3">Search</h3>
            <div class="relative">
              <input 
                type="text" 
                name="search"
                value={searchQuery || ''}
                placeholder="OE number or keyword..."
                class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
              />
              <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </button>
            </div>
          </div>
        </form>
      </aside>

      <!-- Products Grid -->
      <main class="flex-grow">
        <div class="flex items-center justify-between mb-6">
          <p class="text-gray-600">
            Showing <span class="font-semibold">{displayProducts.length}</span> 
            {totalProducts > 0 && <span>of {totalProducts}</span>} products
          </p>
          <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
            <option>Sort by: Newest</option>
            <option>Sort by: Name A-Z</option>
            <option>Sort by: Name Z-A</option>
            <option>Sort by: Brand</option>
          </select>
        </div>

        {displayProducts.length === 0 ? (
          <div class="bg-white rounded-xl shadow-sm p-12 text-center">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No products found</h3>
            <p class="text-gray-500 mb-4">Try adjusting your filters or search terms</p>
            <a href="/products" class="text-primary hover:underline">Clear all filters</a>
          </div>
        ) : (
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
            {displayProducts.map(product => (
              <a 
                href={`/products/${product.slug}`}
                class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow group"
              >
                <div class="aspect-square bg-gray-100 relative overflow-hidden">
                  {product.main_image_url ? (
                    <img 
                      src={product.main_image_url} 
                      alt={product.name}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                  ) : (
                    <div class="absolute inset-0 flex items-center justify-center bg-gray-200">
                      <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                    </div>
                  )}
                  <div class="absolute top-3 left-3">
                    <span class="bg-primary text-white text-xs font-medium px-2 py-1 rounded">
                      {product.brand_name}
                    </span>
                  </div>
                </div>
                <div class="p-4">
                  <h3 class="font-semibold text-gray-900 mb-1 group-hover:text-primary transition-colors line-clamp-2">
                    {product.name}
                  </h3>
                  <p class="text-sm text-gray-500 mb-2">{product.category_name}</p>
                  <p class="text-sm text-gray-600 mb-3 line-clamp-2">{product.short_description || product.description}</p>
                  <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">OE: {product.oe_number}</span>
                    <span class="text-primary font-medium text-sm">View Details →</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        )}

        <!-- Pagination -->
        {totalPages > 1 && (
          <div class="mt-8 flex justify-center">
            <nav class="flex items-center gap-2">
              {currentPage > 1 ? (
                <a 
                  href={buildPageUrl(currentPage - 1)}
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                  Previous
                </a>
              ) : (
                <span class="px-4 py-2 border border-gray-300 rounded-lg opacity-50 cursor-not-allowed">
                  Previous
                </span>
              )}
              
              {Array.from({ length: Math.min(totalPages, 5) }, (_, i) => {
                let pageNum: number;
                if (totalPages <= 5) {
                  pageNum = i + 1;
                } else if (currentPage <= 3) {
                  pageNum = i + 1;
                } else if (currentPage >= totalPages - 2) {
                  pageNum = totalPages - 4 + i;
                } else {
                  pageNum = currentPage - 2 + i;
                }
                return pageNum;
              }).map(pageNum => (
                <a 
                  href={buildPageUrl(pageNum)}
                  class={`px-4 py-2 rounded-lg ${
                    pageNum === currentPage 
                      ? 'bg-primary text-white' 
                      : 'border border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  {pageNum}
                </a>
              ))}
              
              {currentPage < totalPages ? (
                <a 
                  href={buildPageUrl(currentPage + 1)}
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                  Next
                </a>
              ) : (
                <span class="px-4 py-2 border border-gray-300 rounded-lg opacity-50 cursor-not-allowed">
                  Next
                </span>
              )}
            </nav>
          </div>
        )}
      </main>
    </div>
  </div>
</Layout>
