# XKTRUCK 项目实施指南

本文档记录项目的技术实施细节、操作步骤和设计意图，供后续维护和学习参考。

---

## 一、项目架构概述

### 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **前端** | Astro + TailwindCSS | 静态网站生成，SEO 友好 |
| **后端 API** | Cloudflare Workers | 边缘计算，全球低延迟 |
| **数据库** | Supabase (PostgreSQL) | 数据存储，实时订阅 |
| **AI** | DeepSeek API | 智能客服对话 |
| **邮件** | Resend | 询盘通知邮件 |
| **部署** | Cloudflare Pages + GitHub | 自动化 CI/CD |

### 架构图

```
用户访问
    ↓
Cloudflare CDN (全球边缘节点)
    ↓
┌─────────────────────────────────────────┐
│  前端 (Astro)                            │
│  - 静态页面 (产品、博客、关于我们)         │
│  - 动态组件 (AI 客服、联系表单)            │
└─────────────────────────────────────────┘
    ↓ API 请求
┌─────────────────────────────────────────┐
│  Cloudflare Worker                       │
│  - /api/chat (AI 对话)                   │
│  - /api/inquiry (询盘提交)               │
│  - /api/whatsapp/webhook (WhatsApp)      │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Supabase                                │
│  - 产品数据                              │
│  - 询盘记录                              │
│  - 对话历史                              │
│  - 知识库                                │
└─────────────────────────────────────────┘
```

---

## 二、环境配置

### 2.1 多环境设计

**文件**: `xk-truck-worker/wrangler.toml`

```toml
# 默认配置
[vars]
CORS_ORIGIN = "https://xk-truck.cn"

# 生产环境
[env.production]
vars = { CORS_ORIGIN = "https://xk-truck.cn" }

# 开发环境
[env.development]
vars = { CORS_ORIGIN = "*" }
```

**设计意图**:
- **生产环境**: CORS 只允许 `xk-truck.cn`，防止其他网站盗用 API
- **开发环境**: CORS 允许所有来源，方便本地 `localhost` 调试

**部署命令**:
```bash
# 部署到默认环境（推荐）
wrangler deploy --env=""

# 部署到生产环境（会创建新的 Worker）
wrangler deploy --env=production
```

### 2.2 密钥管理

**原则**: 敏感信息不写入代码，通过 `wrangler secret` 管理

```bash
# 设置密钥（交互式输入，不会显示在终端）
wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_SERVICE_KEY
wrangler secret put DEEPSEEK_API_KEY
wrangler secret put RESEND_API_KEY
wrangler secret put NOTIFY_EMAIL

# WhatsApp 相关（待配置）
wrangler secret put WHATSAPP_PHONE_NUMBER_ID
wrangler secret put WHATSAPP_ACCESS_TOKEN
wrangler secret put WHATSAPP_VERIFY_TOKEN
```

**设计意图**:
- 密钥存储在 Cloudflare 的安全存储中
- 代码仓库不包含任何敏感信息
- 不同环境可以使用不同的密钥

---

## 三、前端开发

### 3.1 博客功能

**目录结构**:
```
src/
├── content/
│   ├── config.ts          # 内容集合配置
│   └── blog/               # 博客文章 (Markdown)
│       ├── article-1.md
│       └── article-2.md
└── pages/
    └── blog/
        ├── index.astro     # 博客列表页
        └── [...slug].astro # 博客详情页（动态路由）
```

**设计意图**:
- 使用 Astro Content Collections 管理博客
- Markdown 文件便于编写和版本控制
- 静态生成，SEO 友好
- 支持 Featured 文章标记

**添加新文章**:
```markdown
---
title: "文章标题"
description: "文章描述（用于 SEO）"
pubDate: 2025-12-12
author: "XKTRUCK Team"
tags: ["truck-parts", "maintenance"]
featured: false
---

文章正文内容...
```

### 3.2 导航栏配置

**文件**: `src/components/Header.astro`

```javascript
const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/products', label: 'Products' },
  { href: '/blog', label: 'Blog' },
  { href: '/about', label: 'About Us' },
  { href: '/contact', label: 'Contact' },
];
```

**设计意图**: 集中管理导航链接，便于维护

---

## 四、后端 API 开发

### 4.1 Worker 路由结构

**文件**: `xk-truck-worker/src/index.js`

```javascript
// 路由映射
/api/inquiry          → handleInquiry()      // 询盘提交
/api/chat             → handleChat()         // AI 对话
/api/settings         → handleSettings()     // 系统设置
/api/admin/*          → handleAdmin()        // 后台管理
/api/whatsapp/webhook → handleWhatsApp()     // WhatsApp
/api/health           → 健康检查
```

**设计意图**:
- 单一入口，统一路由
- 模块化 handler，职责分离
- 统一 CORS 处理

### 4.2 WhatsApp 集成

**文件**: `xk-truck-worker/src/handlers/whatsapp.js`

**功能流程**:
```
客户发送 WhatsApp 消息
    ↓
Meta 服务器调用 Webhook (POST /api/whatsapp/webhook)
    ↓
Worker 解析消息内容
    ↓
存储消息到 Supabase (whatsapp_messages 表)
    ↓
调用 DeepSeek AI 生成回复
    ↓
通过 Meta Graph API 发送回复
    ↓
存储 AI 回复到数据库
```

**设计意图**:
- 所有对话记录自动保存，便于后续分析
- AI 自动回复减少人工成本
- 支持在后台管理系统查看对话

**Webhook 验证**:
```javascript
// Meta 会发送 GET 请求验证 Webhook
if (mode === 'subscribe' && token === env.WHATSAPP_VERIFY_TOKEN) {
  return new Response(challenge, { status: 200 });
}
```

---

## 五、数据库设计

### 5.1 WhatsApp 相关表

**文件**: `xk-truck-worker/sql/whatsapp-tables.sql`

```sql
-- 对话表
CREATE TABLE whatsapp_conversations (
  id UUID PRIMARY KEY,
  phone_number VARCHAR(20) UNIQUE,  -- 客户手机号
  contact_name VARCHAR(100),         -- 客户名称
  status VARCHAR(20),                -- active/archived/blocked
  last_message TEXT,                 -- 最后一条消息（预览）
  last_message_at TIMESTAMPTZ,       -- 最后消息时间
  tags TEXT[],                       -- 标签（如 VIP、潜在客户）
  notes TEXT                         -- 内部备注
);

-- 消息表
CREATE TABLE whatsapp_messages (
  id UUID PRIMARY KEY,
  conversation_id UUID REFERENCES whatsapp_conversations(id),
  direction VARCHAR(10),             -- incoming/outgoing
  content TEXT,                      -- 消息内容
  message_type VARCHAR(20),          -- text/image/document
  is_ai_response BOOLEAN             -- 是否 AI 回复
);
```

**设计意图**:
- 对话和消息分离，便于查询
- 支持标签和备注，便于客户管理
- 记录 AI 回复标记，便于质量分析

---

## 六、部署流程

### 6.1 前端部署

**自动部署**: 推送到 GitHub main 分支后，Cloudflare Pages 自动构建部署

```bash
git add -A
git commit -m "feat: add new feature"
git push
```

**手动部署**:
```bash
cd xk-truck-frontend
npm run build
# 然后在 Cloudflare Pages 手动触发部署
```

### 6.2 Worker 部署

```bash
cd xk-truck-worker

# 登录 Cloudflare（首次需要）
wrangler login

# 部署到生产
wrangler deploy --env=""

# 查看日志
wrangler tail
```

**设计意图**:
- 前端通过 GitHub 自动部署，减少人工操作
- Worker 手动部署，避免意外更新

---

## 七、SEO 配置

### 7.1 Google Analytics 4

**文件**: `src/layouts/Layout.astro`

```html
<!-- GA4 追踪代码 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L4H3GET9H5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-L4H3GET9H5');
</script>
```

**设计意图**:
- 放在全局 Layout 中，所有页面自动加载
- 追踪用户行为，分析流量来源

### 7.2 Sitemap

**配置**: `astro.config.mjs`

```javascript
import sitemap from '@astrojs/sitemap';

export default defineConfig({
  site: 'https://xk-truck.cn',
  integrations: [sitemap()],
});
```

**设计意图**: 自动生成 sitemap，便于搜索引擎收录

---

## 八、常用命令速查

### 开发

```bash
# 前端开发
cd xk-truck-frontend
npm run dev                    # 启动开发服务器 (localhost:4321)

# Worker 本地开发
cd xk-truck-worker
wrangler dev                   # 启动本地 Worker
```

### 部署

```bash
# 前端（自动）
git push                       # 推送后自动部署

# Worker
wrangler deploy --env=""       # 部署到生产
wrangler tail                  # 查看实时日志
```

### 密钥管理

```bash
wrangler secret put KEY_NAME   # 添加密钥
wrangler secret list           # 列出所有密钥
wrangler secret delete KEY_NAME # 删除密钥
```

### 数据库

```bash
# 在 Supabase Dashboard 的 SQL Editor 中执行 SQL 文件
# 或使用 Supabase CLI
supabase db push
```

---

## 九、待完成任务

| 任务 | 状态 | 说明 |
|------|------|------|
| WhatsApp API 配置 | ⏳ 待配置 | 等 Meta 开发者账号验证 |
| Bing Webmaster | ⏳ 待提交 | 等 GSC 审核完成后导入 |
| 产品数据同步 | ⏳ 待完成 | 等源网站数据就绪 |
| 知识库完善 | ⏳ 待完成 | 提升 AI 回复质量 |

---

## 十、故障排查

### Worker 部署失败

**问题**: `fetch failed` 错误
**原因**: 网络不稳定
**解决**: 重试部署命令

### 导入错误

**问题**: `No matching export for import`
**原因**: 函数名不匹配
**解决**: 检查 lib 文件的导出名称，确保 import 和 export 一致

### CORS 错误

**问题**: 浏览器报 CORS 错误
**原因**: API 不允许当前域名访问
**解决**: 
- 开发环境使用 `--env=development`
- 或在 `wrangler.toml` 添加允许的域名

---

*最后更新: 2025-12-12*
