# XKTRUCK 项目实施指南

本文档记录**整个项目从零搭建的完整步骤**，包括每一步的具体操作和设计意图。

---

# 第一部分：项目初始化

## 1.1 创建 GitHub 仓库

### 做什么
创建代码仓库，用于版本控制和自动部署。

### 怎么做
1. 登录 https://github.com
2. 点击右上角 `+` → `New repository`
3. 填写仓库名：`TruckB2B`
4. 选择 `Private`（私有仓库）
5. 点击 `Create repository`

### 为什么
- **版本控制**：记录所有代码变更，可随时回退
- **自动部署**：Cloudflare Pages 监听仓库变化自动部署
- **协作基础**：多人开发时合并代码

---

## 1.2 创建前端项目（Astro）

### 做什么
搭建网站前端框架。

### 怎么做

> **在哪里执行命令**：打开 VS Code 终端（快捷键 `Ctrl + `` `），或 Windows PowerShell

**第 1 步**：在项目根目录下创建前端项目
```bash
# 在 d:\github\funNovels\TruckB2B 目录下执行
npm create astro@latest xk-truck-frontend
```
执行后会出现交互式选项：
- 选择模板：`Empty`
- 安装依赖：`Yes`
- TypeScript：`No`

**第 2 步**：进入前端项目目录
```bash
cd xk-truck-frontend
```

**第 3 步**：安装 TailwindCSS（样式框架）
```bash
# 在 d:\github\funNovels\TruckB2B\xk-truck-frontend 目录下执行
npx astro add tailwind
```

**第 4 步**：安装 Sitemap 插件（SEO 用）
```bash
npx astro add sitemap
```

### 为什么选 Astro
- **静态生成**：页面预渲染成 HTML，加载快
- **SEO 友好**：搜索引擎可直接抓取内容
- **零 JS 默认**：不需要交互的页面不加载 JS
- **组件化**：可复用的 `.astro` 组件

---

## 1.3 创建后端项目（Cloudflare Worker）

### 做什么
搭建 API 服务，处理表单提交、AI 对话等。

### 怎么做

**第 1 步**：回到项目根目录，创建 Worker 项目
```bash
# 在 d:\github\funNovels\TruckB2B 目录下执行
npm create cloudflare@latest xk-truck-worker
```
执行后会出现交互式选项：
- 选择模板：`Hello World`
- TypeScript：`No`

**第 2 步**：进入 Worker 项目目录
```bash
cd xk-truck-worker
```

**第 3 步**：登录 Cloudflare 账号
```bash
# 在 d:\github\funNovels\TruckB2B\xk-truck-worker 目录下执行
wrangler login
```
执行后会自动打开浏览器，登录 Cloudflare 账号授权即可。

### 为什么选 Cloudflare Worker
- **全球边缘部署**：300+ 节点，用户访问延迟低
- **免费额度高**：每天 10 万次请求免费
- **无需服务器**：不用管运维、扩容
- **冷启动快**：毫秒级响应

---

## 1.4 创建数据库（Supabase）

### 做什么
存储产品数据、询盘记录、对话历史等。

### 怎么做
1. 访问 https://supabase.com
2. 点击 `Start your project`
3. 用 GitHub 登录
4. 点击 `New project`
5. 填写项目名：`xk-truck`
6. 设置数据库密码（记下来）
7. 选择区域：`Southeast Asia (Singapore)`
8. 点击 `Create new project`

### 获取连接信息
1. 进入项目 → 左侧 `Settings` → `API`
2. 复制 `Project URL`（即 SUPABASE_URL）
3. 复制 `service_role` 密钥（即 SUPABASE_SERVICE_KEY）

### 为什么选 Supabase
- **PostgreSQL**：成熟稳定的关系型数据库
- **免费额度**：500MB 存储，足够初期使用
- **实时订阅**：数据变化可推送到前端
- **REST API**：自动生成，无需写后端

---

## 1.5 申请 AI 服务（DeepSeek）

### 做什么
获取 AI 对话能力，用于智能客服。

### 怎么做
1. 访问 https://platform.deepseek.com
2. 注册账号
3. 进入控制台 → `API Keys`
4. 点击 `Create new API key`
5. 复制密钥（只显示一次）

### 为什么选 DeepSeek
- **中文能力强**：理解中文语境
- **价格便宜**：约 GPT-4 的 1/10
- **响应快**：国内访问延迟低

---

## 1.6 申请邮件服务（Resend）

### 做什么
发送询盘通知邮件。

### 怎么做
1. 访问 https://resend.com
2. 用 GitHub 登录
3. 进入 `API Keys`
4. 点击 `Create API Key`
5. 复制密钥

### 为什么选 Resend
- **免费额度**：每月 3000 封
- **开发者友好**：API 简单
- **送达率高**：不容易进垃圾箱

---

# 第二部分：配置部署环境

## 2.1 配置 Cloudflare Pages（前端自动部署）

### 做什么
让前端代码推送到 GitHub 后自动部署。

### 怎么做
1. 登录 https://dash.cloudflare.com
2. 左侧菜单 → `Workers & Pages`
3. 点击 `Create` → `Pages` → `Connect to Git`
4. 选择 GitHub 仓库 `TruckB2B`
5. 配置构建设置：
   - **Project name**: `xk-truck`
   - **Production branch**: `main`
   - **Build command**: `npm run build`
   - **Build output directory**: `dist`
   - **Root directory**: `xk-truck-frontend`
6. 点击 `Save and Deploy`

### 为什么
- **自动化**：推送代码后 1-2 分钟自动上线
- **预览环境**：每个 PR 自动生成预览链接
- **回滚方便**：一键回退到任意版本

---

## 2.2 配置 Worker 密钥

### 做什么
将敏感信息（API 密钥）安全存储。

### 怎么做

> **在哪里执行命令**：在 `d:\github\funNovels\TruckB2B\xk-truck-worker` 目录下

**第 1 步**：打开终端，进入 Worker 目录
```bash
cd d:\github\funNovels\TruckB2B\xk-truck-worker
```

**第 2 步**：逐个添加密钥（每个命令执行后会提示输入密钥值）
```bash
# 数据库地址
wrangler secret put SUPABASE_URL
# 提示输入时，粘贴：https://xxx.supabase.co

# 数据库密钥
wrangler secret put SUPABASE_SERVICE_KEY
# 提示输入时，粘贴：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# AI 服务密钥
wrangler secret put DEEPSEEK_API_KEY
# 提示输入时，粘贴：sk-xxx

# 邮件服务密钥
wrangler secret put RESEND_API_KEY
# 提示输入时，粘贴：re_xxx

# 通知邮箱
wrangler secret put NOTIFY_EMAIL
# 提示输入时，输入：your@email.com
```

> **注意**：输入密钥时屏幕不会显示内容，这是正常的安全设计

### 为什么用 secret 而不是写在代码里
- **安全**：密钥不会出现在 GitHub
- **加密存储**：Cloudflare 加密保存
- **环境隔离**：不同环境可用不同密钥

---

## 2.3 配置自定义域名

### 做什么
让网站使用自己的域名访问。

### 怎么做

**前端域名**：
1. Cloudflare Pages → 项目 → `Custom domains`
2. 点击 `Set up a custom domain`
3. 输入 `xk-truck.cn`
4. 按提示添加 DNS 记录

**API 域名**（可选）：
1. Workers & Pages → 项目 → `Triggers` → `Custom Domains`
2. 添加 `api.xk-truck.cn`

### 为什么
- **品牌形象**：专业的域名更可信
- **SEO**：自有域名积累权重

---

## 2.4 创建数据库表

### 做什么
在 Supabase 创建存储数据的表结构。

### 怎么做
1. 打开 Supabase Dashboard → SQL Editor
2. 执行以下 SQL：

```sql
-- 产品表
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category VARCHAR(50),
  brand VARCHAR(50),
  oe_number VARCHAR(100),
  price_range VARCHAR(50),
  images TEXT[],
  specifications JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 询盘表
CREATE TABLE inquiries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL,
  company VARCHAR(200),
  phone VARCHAR(50),
  subject VARCHAR(200),
  message TEXT NOT NULL,
  product_id UUID REFERENCES products(id),
  product_name VARCHAR(200),
  source VARCHAR(50) DEFAULT 'website',
  status VARCHAR(20) DEFAULT 'new',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 对话表
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id VARCHAR(100) NOT NULL,
  role VARCHAR(20) NOT NULL,
  message TEXT NOT NULL,
  is_ai BOOLEAN DEFAULT FALSE,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 设置表
CREATE TABLE settings (
  key VARCHAR(50) PRIMARY KEY,
  value JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 知识库表（AI 客服用）
CREATE TABLE knowledge_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  category VARCHAR(50),
  metadata JSONB,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 为知识库内容创建全文搜索索引
CREATE INDEX knowledge_base_content_idx ON knowledge_base USING GIN (to_tsvector('english', content));

-- 插入默认设置
INSERT INTO settings (key, value) VALUES (
  'ai_config',
  '{"ai_enabled": true, "welcome_message": "Hello! How can I help you today?"}'
);
```

### 为什么这样设计
- **UUID 主键**：分布式友好，不暴露数据量
- **JSONB 类型**：灵活存储结构化数据
- **时间戳**：记录创建时间，便于排序

---

# 第三部分：开发核心功能

## 3.1 创建 API 路由（Worker）

### 做什么
定义后端 API 端点。

### 文件：`xk-truck-worker/src/index.js`

```javascript
import { handleInquiry } from './handlers/inquiry.js';
import { handleChat } from './handlers/chat.js';

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;

    // CORS 预检
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': env.CORS_ORIGIN,
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        }
      });
    }

    let response;
    
    // 路由分发
    if (path === '/api/inquiry' && request.method === 'POST') {
      response = await handleInquiry(request, env);
    } else if (path === '/api/chat' && request.method === 'POST') {
      response = await handleChat(request, env);
    } else {
      response = new Response('Not Found', { status: 404 });
    }

    // 添加 CORS 头
    response.headers.set('Access-Control-Allow-Origin', env.CORS_ORIGIN);
    return response;
  }
};
```

### 为什么这样设计
- **单一入口**：所有请求经过 `fetch`，便于统一处理
- **模块化**：每个功能独立文件，便于维护
- **CORS 处理**：允许前端跨域调用

---

## 3.2 实现询盘提交

### 做什么
处理联系表单提交，保存到数据库并发邮件通知。

### 文件：`xk-truck-worker/src/handlers/inquiry.js`

```javascript
import { createClient } from '@supabase/supabase-js';
import { Resend } from 'resend';

export async function handleInquiry(request, env) {
  const data = await request.json();
  
  // 1. 保存到数据库
  const supabase = createClient(env.SUPABASE_URL, env.SUPABASE_SERVICE_KEY);
  await supabase.from('inquiries').insert({
    name: data.name,
    email: data.email,
    company: data.company,
    message: data.message,
  });

  // 2. 发送邮件通知
  const resend = new Resend(env.RESEND_API_KEY);
  await resend.emails.send({
    from: 'XKTRUCK <noreply@xk-truck.cn>',
    to: env.NOTIFY_EMAIL,
    subject: `New Inquiry from ${data.name}`,
    html: `<p>${data.message}</p>`
  });

  return new Response(JSON.stringify({ success: true }));
}
```

### 为什么
- **双重保障**：数据库存储 + 邮件通知
- **异步处理**：不阻塞用户操作

---

## 3.3 实现 AI 客服

### 做什么
接收用户消息，调用 AI 生成回复。

### 文件：`xk-truck-worker/src/handlers/chat.js`

```javascript
export async function handleChat(request, env) {
  const { message, sessionId } = await request.json();
  
  // 1. 获取对话历史
  const history = await getHistory(env, sessionId);
  
  // 2. 调用 DeepSeek API
  const response = await fetch('https://api.deepseek.com/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${env.DEEPSEEK_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'deepseek-chat',
      messages: [
        { role: 'system', content: 'You are a helpful assistant for XKTRUCK...' },
        ...history,
        { role: 'user', content: message }
      ]
    })
  });

  const data = await response.json();
  const reply = data.choices[0].message.content;

  // 3. 保存对话记录
  await saveConversation(env, sessionId, message, reply);

  return new Response(JSON.stringify({ reply }));
}
```

### 为什么
- **上下文记忆**：传入历史对话，AI 理解上下文
- **系统提示词**：定义 AI 角色和行为规范
- **记录保存**：便于后续分析和改进

---

## 3.4 配置 AI 知识库

### 做什么
让 AI 客服能够回答关于你公司和产品的具体问题。

### 工作原理

```
用户提问："你们有沃尔沃 FH4 的大灯吗？"
        ↓
Worker 在知识库中搜索相关内容
        ↓
找到匹配的产品信息
        ↓
将产品信息 + 用户问题 一起发给 AI
        ↓
AI 根据知识库内容生成准确回答
```

### 怎么做

**第 1 步**：在 Supabase 创建知识库表（如果还没创建）

> **在哪里执行**：Supabase Dashboard → SQL Editor

```sql
-- 知识库表
CREATE TABLE IF NOT EXISTS knowledge_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  category VARCHAR(50),
  metadata JSONB,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建全文搜索索引
CREATE INDEX IF NOT EXISTS knowledge_base_content_idx 
ON knowledge_base USING GIN (to_tsvector('english', content));
```

**第 2 步**：添加知识库内容

> **在哪里执行**：Supabase Dashboard → Table Editor → knowledge_base → Insert row

**示例 1：公司介绍**
```sql
INSERT INTO knowledge_base (title, content, category) VALUES (
  'Company Introduction',
  'XKTRUCK (also known as XKLAMP) is a professional manufacturer of heavy truck parts located in China. We have a 35,000 square meter factory and produce headlamps, mirrors, and exterior parts for VOLVO, SCANIA, MERCEDES-BENZ, MAN, IVECO, RENAULT, DAF, and FORD trucks. All products are ADB certified and meet OEM quality standards.',
  'company'
);
```

**示例 2：产品信息**
```sql
INSERT INTO knowledge_base (title, content, category) VALUES (
  'VOLVO FH4 Headlamp',
  'We offer VOLVO FH4 LED Headlamps with OE number 21221129. Features: LED technology, ADB certified, direct fit replacement. Compatible with VOLVO FH4 2013-2020 and FM4 2013-2020. Available in left and right versions.',
  'product'
);
```

**示例 3：常见问题**
```sql
INSERT INTO knowledge_base (title, content, category) VALUES (
  'Minimum Order Quantity',
  'Our minimum order quantity (MOQ) varies by product. For most items, we can accommodate small trial orders starting from 5-10 pieces. For large quantity orders, we offer better pricing. Please contact us for specific product MOQ.',
  'faq'
);

INSERT INTO knowledge_base (title, content, category) VALUES (
  'Shipping and Delivery',
  'We ship worldwide via sea freight, air freight, or express courier (DHL, FedEx, UPS). Standard delivery time is 15-30 days depending on destination. Express shipping is available for urgent orders. We handle all export documentation.',
  'faq'
);

INSERT INTO knowledge_base (title, content, category) VALUES (
  'Payment Methods',
  'We accept T/T (bank transfer), PayPal, and Western Union. For new customers, we typically require 30% deposit before production and 70% before shipment. For established customers, we can discuss flexible payment terms.',
  'faq'
);

INSERT INTO knowledge_base (title, content, category) VALUES (
  'Quality and Warranty',
  'All our products are ADB certified and manufactured to OEM specifications. We provide a 12-month warranty on all products. If any quality issues arise within the warranty period, we will replace the defective parts free of charge.',
  'faq'
);
```

**第 3 步**：测试知识库

在网站的 AI 客服中测试以下问题：
- "What products do you have for VOLVO?"
- "What is your MOQ?"
- "How long is the delivery time?"
- "Do you have warranty?"

### 知识库内容建议

| 类别 | 建议内容 |
|------|----------|
| **company** | 公司介绍、工厂规模、认证资质 |
| **product** | 每个主要产品的详细信息（OE号、适配车型、特点） |
| **faq** | 常见问题：MOQ、付款方式、运费、交期、质保 |
| **policy** | 退换货政策、售后服务 |

### 为什么需要知识库

| 没有知识库 | 有知识库 |
|-----------|----------|
| AI 只能给出通用回答 | AI 能回答具体产品问题 |
| "请联系销售人员" | "我们有 VOLVO FH4 大灯，OE号 21221129..." |
| 客户体验差 | 客户能快速获得信息 |

---

# 第四部分：SEO 配置

## 4.1 配置 Google Analytics 4

### 做什么
追踪网站访问数据。

### 怎么做
1. 访问 https://analytics.google.com
2. 创建账号和媒体资源
3. 获取衡量 ID（G-XXXXXXXX）
4. 在 `src/layouts/Layout.astro` 的 `<head>` 中添加：

```html
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L4H3GET9H5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-L4H3GET9H5');
</script>
```

### 为什么
- **流量分析**：了解用户来源和行为
- **转化追踪**：衡量询盘效果

---

## 4.2 提交 Google Search Console

### 做什么
让 Google 收录网站。

### 怎么做
1. 访问 https://search.google.com/search-console
2. 添加资源 → 输入域名
3. 验证所有权（DNS 或 HTML 文件）
4. 提交 Sitemap：`https://xk-truck.cn/sitemap-index.xml`

### 为什么
- **加速收录**：主动告知 Google 网站存在
- **监控问题**：发现抓取错误

---

# 第五部分：日常运维

## 5.1 部署前端

### 做什么
更新网站前端代码。

### 怎么做

> **在哪里执行命令**：在项目根目录 `d:\github\funNovels\TruckB2B` 下

```bash
# 第 1 步：添加所有变更
git add -A

# 第 2 步：提交变更（写清楚做了什么）
git commit -m "feat: add new feature"

# 第 3 步：推送到 GitHub（推送后自动部署）
git push
```

> **提交信息格式**：
> - `feat:` 新功能
> - `fix:` 修复 bug
> - `docs:` 文档更新
> - `style:` 样式调整

---

## 5.2 部署 Worker

### 做什么
更新后端 API 代码。

### 怎么做

> **在哪里执行命令**：在 `d:\github\funNovels\TruckB2B\xk-truck-worker` 目录下

```bash
# 第 1 步：进入 Worker 目录
cd d:\github\funNovels\TruckB2B\xk-truck-worker

# 第 2 步：部署到 Cloudflare
wrangler deploy --env=""
```

> **为什么加 `--env=""`**：使用默认环境配置，部署到原有的 Worker 地址

---

## 5.3 查看日志

### 做什么
实时查看 API 运行日志，用于调试。

### 怎么做

> **在哪里执行命令**：在 `d:\github\funNovels\TruckB2B\xk-truck-worker` 目录下

```bash
wrangler tail
```

按 `Ctrl + C` 停止查看。

---

## 5.4 添加博客文章

### 做什么
发布新的博客文章。

### 怎么做

**第 1 步**：在 `d:\github\funNovels\TruckB2B\xk-truck-frontend\src\content\blog\` 目录下创建新的 `.md` 文件

**第 2 步**：文件开头添加元数据
```markdown
---
title: "文章标题"
description: "文章描述"
pubDate: 2025-12-12
author: "XKTRUCK Team"
tags: ["tag1", "tag2"]
---

文章正文...
```

**第 3 步**：提交并推送
```bash
git add -A
git commit -m "blog: add new article"
git push
```

---

# 附录：项目文件结构

```
TruckB2B/
├── xk-truck-frontend/          # 前端项目
│   ├── src/
│   │   ├── components/         # 可复用组件
│   │   ├── layouts/            # 页面布局
│   │   ├── pages/              # 页面路由
│   │   └── content/blog/       # 博客文章
│   ├── astro.config.mjs        # Astro 配置
│   └── package.json
│
├── xk-truck-worker/            # 后端 API
│   ├── src/
│   │   ├── handlers/           # 请求处理器
│   │   └── lib/                # 工具函数
│   ├── sql/                    # 数据库脚本
│   ├── wrangler.toml           # Worker 配置
│   └── package.json
│
├── 项目总览.md                  # 项目状态总览
├── 实施指南.md                  # 本文档
└── README.md
```

---

*最后更新: 2025-12-12*
